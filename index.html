<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BGone ‚Äì Offline Background Remover</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg-main: #020509;
      --bg-card: #050a12;
      --text-main: #fdfdf9;
      --text-muted: #9ea7bb;
      --accent: #0099cc;
      --accent-soft: rgba(0, 153, 204, 0.12);
      --border-subtle: rgba(255, 255, 255, 0.08);
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.75);
      --radius-lg: 18px;
      --radius-xl: 24px;
      --danger: #ff5252;
      --success: #00c853;
      --warning: #ffcc33;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #101522 0, #020509 45%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    body[data-theme="light"] {
      --bg-main: #f5f5f7;
      --bg-card: #ffffff;
      --text-main: #111217;
      --text-muted: #4f5462;
      --border-subtle: rgba(0, 0, 0, 0.06);
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.18);
    }

    .app-shell {
      width: min(1200px, 100%);
      margin: 16px;
      background: radial-gradient(circle at top left, rgba(0, 153, 204, 0.06), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(255, 255, 255, 0.04), transparent 60%),
                  var(--bg-main);
      border-radius: 28px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px 10px;
      border-bottom: 1px solid var(--border-subtle);
      backdrop-filter: blur(16px);
      background: linear-gradient(
        to bottom,
        rgba(0, 0, 0, 0.35),
        rgba(0, 0, 0, 0.0)
      );
    }

    body[data-theme="light"] .topbar {
      background: linear-gradient(
        to bottom,
        rgba(255, 255, 255, 0.9),
        rgba(255, 255, 255, 0.7)
      );
    }

    .title-area {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title-area h1 {
      margin: 0;
      font-size: 1.05rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-weight: 600;
    }

    .title-area span {
      font-size: 0.72rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .topbar-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill-btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 3px 10px;
      background: rgba(0, 0, 0, 0.35);
      color: var(--text-main);
      font-size: 0.75rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.16s ease, border-color 0.16s ease,
        transform 0.06s ease;
    }

    body[data-theme="light"] .pill-btn {
      background: rgba(255, 255, 255, 0.9);
    }

    .pill-btn span.dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
    }

    .pill-btn.active {
      background: var(--accent);
      color: #020509;
      border-color: rgba(0, 0, 0, 0.16);
      transform: translateY(0.5px);
    }

    .pill-btn:active {
      transform: translateY(1px) scale(0.99);
    }

    .status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 4px 10px;
      background: rgba(0, 0, 0, 0.35);
    }

    body[data-theme="light"] .status {
      background: rgba(255, 255, 255, 0.9);
    }

    .status-led {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 9px rgba(0, 200, 83, 0.75);
    }

    .status-led.working {
      background: var(--warning);
      box-shadow: 0 0 9px rgba(255, 204, 51, 0.85);
    }

    .status-label {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-weight: 500;
    }

    .main {
      display: grid;
      grid-template-columns: minmax(260px, 300px) minmax(0, 1fr);
      gap: 14px;
      padding: 14px 16px 16px;
      box-sizing: border-box;
    }

    @media (max-width: 840px) {
      .main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.06), transparent 70%),
                  var(--bg-card);
      border-radius: 22px;
      border: 1px solid var(--border-subtle);
      padding: 12px 14px 12px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .panel-header h2 {
      margin: 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      font-weight: 600;
    }

    .panel-header span {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .section-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      margin-bottom: 4px;
      margin-top: 6px;
    }

    .control-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .file-input-wrap {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-input-wrap input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.45);
      color: var(--text-main);
      font-size: 0.78rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: background 0.16s ease, transform 0.06s ease,
        box-shadow 0.16s ease, border-color 0.16s ease;
    }

    body[data-theme="light"] .btn {
      background: rgba(255, 255, 255, 0.9);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--accent), #40c4ff);
      border-color: rgba(0, 0, 0, 0.18);
      color: #020509;
      box-shadow: 0 12px 24px rgba(0, 153, 204, 0.45);
    }

    .btn.danger {
      background: rgba(255, 82, 82, 0.12);
      border-color: rgba(255, 82, 82, 0.75);
      color: #ff8a80;
    }

    .btn.secondary {
      background: rgba(0, 0, 0, 0.3);
    }

    .btn.small {
      padding: 4px 10px;
      font-size: 0.72rem;
    }

    .btn span.icon {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .btn:disabled,
    .pill-btn:disabled {
      opacity: 0.35;
      cursor: default;
      box-shadow: none;
    }

    .btn:not(:disabled):active {
      transform: translateY(1px) scale(0.985);
      box-shadow: none;
    }

    body[data-theme="light"] .btn.primary {
      box-shadow: 0 12px 24px rgba(0, 153, 204, 0.25);
    }

    .hint {
      font-size: 0.7rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .hint strong {
      color: var(--accent);
      font-weight: 600;
    }

    .mode-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn.toggle {
      background: rgba(0, 0, 0, 0.3);
    }

    .btn.toggle.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 0 1px rgba(0, 153, 204, 0.4);
    }

    .slider-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 2px;
      margin-bottom: 4px;
    }

    .slider-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .slider-header span.value {
      color: var(--accent);
      font-variant-numeric: tabular-nums;
    }

    input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      background: transparent;
    }

    input[type="range"]:focus {
      outline: none;
    }

    input[type="range"]::-webkit-slider-runnable-track {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 999px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 14px;
      width: 14px;
      border-radius: 50%;
      background: var(--accent);
      margin-top: -5px;
      box-shadow: 0 0 0 3px rgba(0, 153, 204, 0.35);
      cursor: pointer;
    }

    input[type="range"]::-moz-range-track {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 999px;
    }

    input[type="range"]::-moz-range-thumb {
      height: 14px;
      width: 14px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 153, 204, 0.35);
      cursor: pointer;
      border: none;
    }

    .canvas-panel {
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .canvas-shell {
      position: relative;
      flex: 1;
      min-height: 260px;
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      background-image:
        linear-gradient(45deg, #2a2f3a 25%, transparent 25%),
        linear-gradient(-45deg, #2a2f3a 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #2a2f3a 75%),
        linear-gradient(-45deg, transparent 75%, #2a2f3a 75%);
      background-size: 24px 24px;
      background-position: 0 0, 0 12px, 12px -12px, -12px 0px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body[data-theme="light"] .canvas-shell {
      background-image:
        linear-gradient(45deg, #e0e0e0 25%, transparent 25%),
        linear-gradient(-45deg, #e0e0e0 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #e0e0e0 75%),
        linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);
    }

    #editCanvas {
      max-width: 100%;
      max-height: 70vh;
      display: block;
      image-rendering: auto;
      background: transparent;
      cursor: default;
      transition: filter 0.18s ease;
    }

    #editCanvas.brush-mode {
      cursor: crosshair;
    }

    #editCanvas.brush-mode.painting {
      filter: brightness(1.05);
    }

    .canvas-overlay-text {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.65);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      color: var(--text-muted);
      pointer-events: none;
      backdrop-filter: blur(8px);
      white-space: nowrap;
    }

    body[data-theme="light"] .canvas-overlay-text {
      background: rgba(255, 255, 255, 0.9);
    }

    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .footer-row span.brand {
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    .footer-row a {
      color: var(--accent);
      text-decoration: none;
      border-bottom: 1px dashed rgba(0, 153, 204, 0.6);
    }

    .footer-row a:hover {
      border-bottom-style: solid;
    }

    .hidden-canvas {
      display: none;
    }
  </style>
</head>
<body data-theme="dark">
  <div class="app-shell">
    <header class="topbar">
      <div class="title-area">
        <h1>BGone ‚Äì Background Remover</h1>
        <span id="subtitle">Edge-paint background control, offline.</span>
      </div>
      <div class="topbar-controls">
        <button id="themeToggle" class="pill-btn">
          <span class="dot"></span>
          <span>Dark</span>
        </button>
        <button id="langToggle" class="pill-btn">
          <span>ES</span>
        </button>
        <div class="status">
          <span id="statusLed" class="status-led"></span>
          <span id="statusText" class="status-label">Ready</span>
        </div>
      </div>
    </header>

    <main class="main">
      <!-- LEFT PANEL: Controls -->
      <section class="panel">
        <div class="panel-header">
          <h2>Input and AI pass</h2>
          <span id="fileInfo">No image loaded</span>
        </div>

        <div class="section-label" id="uploadLabel">Image</div>
        <div class="control-row">
          <div class="file-input-wrap">
            <button class="btn secondary small" id="openBtn">
              <span class="icon">‚≠≥</span>
              <span id="openLabel">Open image</span>
            </button>
            <input id="imageInput" type="file" accept="image/*" />
          </div>
          <button class="btn danger small" id="clearBtn">
            <span class="icon">‚úï</span>
            <span id="clearLabel">Clear</span>
          </button>
        </div>
        <div class="hint" id="hintTypes">
          PNG recommended. Large images are downscaled to fit the canvas.
        </div>

        <div class="section-label" id="aiSectionLabel">Automatic background</div>
        <div class="control-row">
          <button class="btn primary" id="autoBtn">
            <span class="icon">‚ö°</span>
            <span id="autoLabel">Auto remove background</span>
          </button>
        </div>
        <div class="hint" id="aiHint">
          This local pass guesses a solid background color from the image edges
          and makes it transparent. Then you can refine with the brush.
        </div>

        <div class="section-label" id="brushSectionLabel">Brush mode</div>
        <div class="control-row">
          <div class="mode-group">
            <button class="btn toggle small" id="eraseBtn">
              <span class="icon">‚àí</span>
              <span id="eraseLabel">Erase background</span>
            </button>
            <button class="btn toggle small" id="restoreBtn">
              <span class="icon">+</span>
              <span id="restoreLabel">Restore</span>
            </button>
            <button class="btn toggle small" id="viewBtn">
              <span class="icon">üëÅ</span>
              <span id="viewLabel">View only</span>
            </button>
          </div>
        </div>

        <div class="slider-row">
          <div class="slider-header">
            <span id="brushSizeLabel">Brush size</span>
            <span class="value"><span id="brushSizeValue">36</span> px</span>
          </div>
          <input id="brushSize" type="range" min="4" max="120" value="36" />
        </div>

        <div class="section-label" id="exportSectionLabel">Export</div>
        <div class="control-row">
          <button class="btn secondary" id="downloadPngBtn">
            <span class="icon">‚¨á</span>
            <span id="downloadPngLabel">Download PNG (transparent)</span>
          </button>
        </div>

        <div class="hint" id="tipText">
          Tip: enable <strong>Erase</strong> or <strong>Restore</strong> and
          paint over the edges directly on the canvas. The cursor will change to
          a crosshair when brush mode is active.
        </div>
      </section>

      <!-- RIGHT PANEL: Canvas -->
      <section class="panel canvas-panel">
        <div class="panel-header">
          <h2 id="canvasTitle">Canvas</h2>
          <span id="canvasHint">Transparent areas show the removed background.</span>
        </div>
        <div class="canvas-shell">
          <canvas id="editCanvas"></canvas>
          <div class="canvas-overlay-text" id="canvasOverlay">
            <span id="overlayText">Load an image to start</span>
          </div>
        </div>
        <div class="footer-row">
          <span class="brand">BGone ¬∑ Offline</span>
          <span id="footerNote">Paint away what the AI misses.</span>
        </div>

        <!-- hidden original canvas for restore and processing -->
        <canvas id="baseCanvas" class="hidden-canvas"></canvas>
      </section>
    </main>
  </div>

  <script>
    // -------------------------------------------------------------------------
    // Elements
    // -------------------------------------------------------------------------
    const imageInput = document.getElementById('imageInput');
    const openBtn = document.getElementById('openBtn');
    const clearBtn = document.getElementById('clearBtn');
    const autoBtn = document.getElementById('autoBtn');
    const eraseBtn = document.getElementById('eraseBtn');
    const restoreBtn = document.getElementById('restoreBtn');
    const viewBtn = document.getElementById('viewBtn');
    const fileInfo = document.getElementById('fileInfo');

    const brushSlider = document.getElementById('brushSize');
    const brushSizeValue = document.getElementById('brushSizeValue');
    const downloadPngBtn = document.getElementById('downloadPngBtn');

    const editCanvas = document.getElementById('editCanvas');
    const baseCanvas = document.getElementById('baseCanvas');
    const ctx = editCanvas.getContext('2d');
    const baseCtx = baseCanvas.getContext('2d');

    const statusLed = document.getElementById('statusLed');
    const statusText = document.getElementById('statusText');
    const canvasOverlay = document.getElementById('canvasOverlay');
    const overlayText = document.getElementById('overlayText');

    const themeToggle = document.getElementById('themeToggle');
    const langToggle = document.getElementById('langToggle');
    const subtitle = document.getElementById('subtitle');

    // -------------------------------------------------------------------------
    // Language strings
    // -------------------------------------------------------------------------
    let currentTheme = localStorage.getItem('bgone_theme') || 'dark';
    let currentLang = localStorage.getItem('bgone_lang') || 'en';

    const STRINGS = {
      en: {
        appTitle: 'BGone ‚Äì Background Remover',
        subtitle: 'Edge-paint background control, offline.',
        fileInfoNone: 'No image loaded',
        uploadLabel: 'Image',
        openLabel: 'Open image',
        clearLabel: 'Clear',
        typesHint: 'PNG recommended. Large images are downscaled to fit the canvas.',
        aiSectionLabel: 'Automatic background',
        autoLabel: 'Auto remove background',
        aiHint:
          'This local pass guesses a solid background color from the image edges and makes it transparent. Then you can refine with the brush.',
        brushSectionLabel: 'Brush mode',
        eraseLabel: 'Erase background',
        restoreLabel: 'Restore',
        viewLabel: 'View only',
        brushSizeLabel: 'Brush size',
        exportSectionLabel: 'Export',
        downloadPngLabel: 'Download PNG (transparent)',
        tipText:
          'Tip: enable Erase or Restore and paint over the edges directly on the canvas. The cursor will change to a crosshair when brush mode is active.',
        canvasTitle: 'Canvas',
        canvasHint: 'Transparent areas show the removed background.',
        overlayIdle: 'Load an image to start',
        overlayReady: 'Use the brush to erase or restore.',
        footerNote: 'Paint away what the AI misses.',
        statusReady: 'Ready',
        statusCleared: 'Image cleared',
        statusLoading: 'Loading image...',
        statusAuto: 'Running auto background...',
        statusEraseMode: 'Mode: Erase background',
        statusRestoreMode: 'Mode: Restore',
        statusViewMode: 'Mode: View only',
        workingErase: 'Erasing...',
        workingRestore: 'Restoring...',
        workingGeneric: 'Working...',
        themeDark: 'Dark',
        themeLight: 'Light',
        langButton: 'ES'
      },
      es: {
        appTitle: 'BGone ‚Äì Eliminador de Fondo',
        subtitle: 'Control de fondo con pincel, sin conexi√≥n.',
        fileInfoNone: 'Sin imagen cargada',
        uploadLabel: 'Imagen',
        openLabel: 'Abrir imagen',
        clearLabel: 'Limpiar',
        typesHint: 'Se recomienda PNG. Las im√°genes grandes se reducen para encajar en el lienzo.',
        aiSectionLabel: 'Fondo autom√°tico',
        autoLabel: 'Eliminar fondo autom√°tico',
        aiHint:
          'Este paso local estima un color de fondo s√≥lido desde los bordes de la imagen y lo vuelve transparente. Luego puedes refinar con el pincel.',
        brushSectionLabel: 'Modo pincel',
        eraseLabel: 'Borrar fondo',
        restoreLabel: 'Restaurar',
        viewLabel: 'Solo ver',
        brushSizeLabel: 'Tama√±o del pincel',
        exportSectionLabel: 'Exportar',
        downloadPngLabel: 'Descargar PNG (transparente)',
        tipText:
          'Tip: activa Borrar o Restaurar y pinta sobre los bordes directamente en el lienzo. El cursor cambiar√° a mira cuando el pincel est√© activo.',
        canvasTitle: 'Lienzo',
        canvasHint: 'Las √°reas transparentes muestran el fondo eliminado.',
        overlayIdle: 'Carga una imagen para comenzar',
        overlayReady: 'Usa el pincel para borrar o restaurar.',
        footerNote: 'Pinta lo que la IA no pudo.',
        statusReady: 'Listo',
        statusCleared: 'Imagen borrada',
        statusLoading: 'Cargando imagen...',
        statusAuto: 'Ejecutando fondo autom√°tico...',
        statusEraseMode: 'Modo: Borrar fondo',
        statusRestoreMode: 'Modo: Restaurar',
        statusViewMode: 'Modo: Solo ver',
        workingErase: 'Borrando...',
        workingRestore: 'Restaurando...',
        workingGeneric: 'Trabajando...',
        themeDark: 'Oscuro',
        themeLight: 'Claro',
        langButton: 'EN'
      }
    };

    function t(key) {
      return STRINGS[currentLang][key] ?? key;
    }

    // -------------------------------------------------------------------------
    // Theme and language
    // -------------------------------------------------------------------------
    function applyTheme() {
      document.body.setAttribute('data-theme', currentTheme);
      if (themeToggle) {
        themeToggle.querySelector('span:nth-child(2)').textContent =
          currentTheme === 'dark' ? t('themeDark') : t('themeLight');
        themeToggle.classList.toggle('active', currentTheme === 'dark');
      }
    }

    function applyLanguage() {
      document.title = t('appTitle');
      document.querySelector('.title-area h1').textContent = t('appTitle');
      subtitle.textContent = t('subtitle');

      document.getElementById('uploadLabel').textContent = t('uploadLabel');
      document.getElementById('openLabel').textContent = t('openLabel');
      document.getElementById('clearLabel').textContent = t('clearLabel');
      document.getElementById('hintTypes').textContent = t('typesHint');
      document.getElementById('aiSectionLabel').textContent = t('aiSectionLabel');
      document.getElementById('autoLabel').textContent = t('autoLabel');
      document.getElementById('aiHint').textContent = t('aiHint');
      document.getElementById('brushSectionLabel').textContent =
        t('brushSectionLabel');
      document.getElementById('eraseLabel').textContent = t('eraseLabel');
      document.getElementById('restoreLabel').textContent = t('restoreLabel');
      document.getElementById('viewLabel').textContent = t('viewLabel');
      document.getElementById('brushSizeLabel').textContent =
        t('brushSizeLabel');
      document.getElementById('exportSectionLabel').textContent =
        t('exportSectionLabel');
      document.getElementById('downloadPngLabel').textContent =
        t('downloadPngLabel');
      document.getElementById('tipText').textContent = t('tipText');
      document.getElementById('canvasTitle').textContent = t('canvasTitle');
      document.getElementById('canvasHint').textContent = t('canvasHint');
      document.getElementById('footerNote').textContent = t('footerNote');
      overlayText.textContent = hasImage ? t('overlayReady') : t('overlayIdle');

      if (!hasImage) {
        fileInfo.textContent = t('fileInfoNone');
      }

      if (!isPainting) {
        statusText.textContent = t('statusReady');
      }

      if (langToggle) {
        langToggle.textContent = t('langButton');
      }

      applyTheme();
      updateStatusMode();
    }

    themeToggle.addEventListener('click', () => {
      currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('bgone_theme', currentTheme);
      applyTheme();
    });

    langToggle.addEventListener('click', () => {
      currentLang = currentLang === 'en' ? 'es' : 'en';
      localStorage.setItem('bgone_lang', currentLang);
      applyLanguage();
    });

    // -------------------------------------------------------------------------
    // Status helpers
    // -------------------------------------------------------------------------
    let currentMode = 'none'; // 'erase' | 'restore' | 'none'
    let isPainting = false;

    function setWorkingIndicator(isWorking, kind) {
      if (isWorking) {
        statusLed.classList.add('working');
        if (kind === 'erase') {
          statusText.textContent = t('workingErase');
        } else if (kind === 'restore') {
          statusText.textContent = t('workingRestore');
        } else {
          statusText.textContent = t('workingGeneric');
        }
      } else {
        statusLed.classList.remove('working');
        statusText.textContent = t('statusReady');
      }
    }

    function updateStatusMode() {
      if (currentMode === 'erase') {
        statusText.textContent = t('statusEraseMode');
      } else if (currentMode === 'restore') {
        statusText.textContent = t('statusRestoreMode');
      } else {
        statusText.textContent = t('statusViewMode');
      }
    }

    function setOverlayVisible(visible, textKey) {
      if (visible) {
        canvasOverlay.style.opacity = '1';
        overlayText.textContent = t(textKey);
      } else {
        canvasOverlay.style.opacity = '0';
      }
    }

    // -------------------------------------------------------------------------
    // Image state
    // -------------------------------------------------------------------------
    let hasImage = false;
    let baseImageData = null; // original after auto removal
    let brushSize = parseInt(brushSlider.value, 10) || 36;
    brushSizeValue.textContent = brushSize;

    function resetCanvas() {
      ctx.clearRect(0, 0, editCanvas.width, editCanvas.height);
      baseCtx.clearRect(0, 0, baseCanvas.width, baseCanvas.height);
      baseImageData = null;
    }

    function resetApp() {
      hasImage = false;
      resetCanvas();
      imageInput.value = '';
      fileInfo.textContent = t('fileInfoNone');
      setOverlayVisible(true, 'overlayIdle');
      setWorkingIndicator(false);
      currentMode = 'none';
      updateModeButtons();
      editCanvas.classList.remove('brush-mode', 'painting');
      statusText.textContent = t('statusCleared');
    }

    clearBtn.addEventListener('click', () => {
      resetApp();
    });

    openBtn.addEventListener('click', () => {
      imageInput.click();
    });

    imageInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      loadImageFile(file);
    });

    function loadImageFile(file) {
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        URL.revokeObjectURL(url);

        statusText.textContent = t('statusLoading');
        hasImage = true;

        const maxW = 1600;
        const maxH = 900;
        let w = img.width;
        let h = img.height;
        const scale = Math.min(1, maxW / w, maxH / h);
        w = Math.round(w * scale);
        h = Math.round(h * scale);

        editCanvas.width = w;
        editCanvas.height = h;
        baseCanvas.width = w;
        baseCanvas.height = h;

        resetCanvas();
        ctx.drawImage(img, 0, 0, w, h);
        baseCtx.drawImage(img, 0, 0, w, h);

        // initial base state is "no background removed"
        baseImageData = baseCtx.getImageData(0, 0, w, h);

        fileInfo.textContent = file.name + ' ¬∑ ' + w + '√ó' + h + ' px';
        setOverlayVisible(false);
        setWorkingIndicator(false);
        statusText.textContent = t('statusReady');

        currentMode = 'none';
        updateModeButtons();
      };
      img.onerror = () => {
        setWorkingIndicator(false);
        statusText.textContent = t('statusReady');
      };

      setWorkingIndicator(true);
      img.src = url;
    }

    // -------------------------------------------------------------------------
    // Simple local "auto background remove"
    // -------------------------------------------------------------------------
    function autoRemoveBackground() {
      if (!hasImage) return;
      setWorkingIndicator(true);
      statusText.textContent = t('statusAuto');

      const w = editCanvas.width;
      const h = editCanvas.height;
      const imageData = ctx.getImageData(0, 0, w, h);
      const data = imageData.data;

      // estimate background color from border pixels
      let rSum = 0, gSum = 0, bSum = 0, count = 0;
      const margin = Math.max(4, Math.round(Math.min(w, h) * 0.04));

      function sample(x, y) {
        const idx = (y * w + x) * 4;
        const r = data[idx];
        const g = data[idx + 1];
        const b = data[idx + 2];
        const a = data[idx + 3];
        if (a > 10) {
          rSum += r;
          gSum += g;
          bSum += b;
          count++;
        }
      }

      for (let x = 0; x < w; x++) {
        for (let y = 0; y < margin; y++) sample(x, y);
        for (let y = h - margin; y < h; y++) sample(x, y);
      }
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < margin; x++) sample(x, y);
        for (let x = w - margin; x < w; x++) sample(x, y);
      }

      if (count === 0) {
        setWorkingIndicator(false);
        statusText.textContent = t('statusReady');
        return;
      }

      const bgR = rSum / count;
      const bgG = gSum / count;
      const bgB = bSum / count;

      // threshold based on distance to background color
      const threshold = 38; // tweakable
      const thresholdSquared = threshold * threshold;

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const a = data[i + 3];
        if (a < 15) {
          continue;
        }
        const dr = r - bgR;
        const dg = g - bgG;
        const db = b - bgB;
        const dist2 = dr * dr + dg * dg + db * db;
        if (dist2 < thresholdSquared) {
          data[i + 3] = 0; // transparent
        }
      }

      ctx.putImageData(imageData, 0, 0);
      baseImageData = ctx.getImageData(0, 0, w, h);

      setOverlayVisible(true, 'overlayReady');
      setWorkingIndicator(false);
      statusText.textContent = t('statusReady');
    }

    autoBtn.addEventListener('click', () => {
      if (!hasImage) return;
      autoRemoveBackground();
    });

    // -------------------------------------------------------------------------
    // Brush painting
    // -------------------------------------------------------------------------
    brushSlider.addEventListener('input', (e) => {
      brushSize = parseInt(e.target.value, 10) || 36;
      brushSizeValue.textContent = brushSize;
    });

    function updateModeButtons() {
      const modes = [
        { btn: eraseBtn, mode: 'erase' },
        { btn: restoreBtn, mode: 'restore' },
        { btn: viewBtn, mode: 'none' }
      ];
      modes.forEach(({ btn, mode }) => {
        btn.classList.toggle('active', currentMode === mode);
      });

      if (currentMode === 'erase' || currentMode === 'restore') {
        editCanvas.classList.add('brush-mode');
      } else {
        editCanvas.classList.remove('brush-mode', 'painting');
      }
    }

    eraseBtn.addEventListener('click', () => {
      if (!hasImage) return;
      currentMode = 'erase';
      updateModeButtons();
      updateStatusMode();
      setOverlayVisible(true, 'overlayReady');
    });

    restoreBtn.addEventListener('click', () => {
      if (!hasImage) return;
      currentMode = 'restore';
      updateModeButtons();
      updateStatusMode();
      setOverlayVisible(true, 'overlayReady');
    });

    viewBtn.addEventListener('click', () => {
      if (!hasImage) return;
      currentMode = 'none';
      updateModeButtons();
      updateStatusMode();
      setOverlayVisible(false);
    });

    let isMouseDown = false;

    function canvasPosFromEvent(e) {
      const rect = editCanvas.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * editCanvas.width;
      const y = ((e.clientY - rect.top) / rect.height) * editCanvas.height;
      return { x, y };
    }

    function applyBrush(x, y) {
      if (!hasImage || (!baseImageData && currentMode === 'restore')) return;

      const w = editCanvas.width;
      const h = editCanvas.height;
      if (w === 0 || h === 0) return;

      const radius = brushSize / 2;
      const r2 = radius * radius;

      const x0 = Math.max(0, Math.floor(x - radius));
      const y0 = Math.max(0, Math.floor(y - radius));
      const x1 = Math.min(w - 1, Math.ceil(x + radius));
      const y1 = Math.min(h - 1, Math.ceil(y + radius));

      const currentData = ctx.getImageData(x0, y0, x1 - x0 + 1, y1 - y0 + 1);
      const cd = currentData.data;

      if (currentMode === 'erase') {
        for (let py = y0; py <= y1; py++) {
          for (let px = x0; px <= x1; px++) {
            const dx = px - x;
            const dy = py - y;
            if (dx * dx + dy * dy <= r2) {
              const localX = px - x0;
              const localY = py - y0;
              const idx = (localY * (x1 - x0 + 1) + localX) * 4;
              cd[idx + 3] = 0; // alpha
            }
          }
        }
      } else if (currentMode === 'restore' && baseImageData) {
        const baseData = baseImageData.data;
        const baseW = baseImageData.width;

        for (let py = y0; py <= y1; py++) {
          for (let px = x0; px <= x1; px++) {
            const dx = px - x;
            const dy = py - y;
            if (dx * dx + dy * dy <= r2) {
              const localX = px - x0;
              const localY = py - y0;
              const localIdx = (localY * (x1 - x0 + 1) + localX) * 4;
              const baseIdx = (py * baseW + px) * 4;
              cd[localIdx] = baseData[baseIdx];
              cd[localIdx + 1] = baseData[baseIdx + 1];
              cd[localIdx + 2] = baseData[baseIdx + 2];
              cd[localIdx + 3] = baseData[baseIdx + 3];
            }
          }
        }
      }

      ctx.putImageData(currentData, x0, y0);
    }

    editCanvas.addEventListener('mousedown', (e) => {
      if (!hasImage) return;
      if (currentMode !== 'erase' && currentMode !== 'restore') return;
      isMouseDown = true;
      editCanvas.classList.add('painting');
      const { x, y } = canvasPosFromEvent(e);
      isPainting = true;
      setWorkingIndicator(true, currentMode);
      applyBrush(x, y);
    });

    editCanvas.addEventListener('mousemove', (e) => {
      if (!isMouseDown || !hasImage) return;
      if (currentMode !== 'erase' && currentMode !== 'restore') return;
      const { x, y } = canvasPosFromEvent(e);
      applyBrush(x, y);
    });

    function stopPainting() {
      if (!isMouseDown) return;
      isMouseDown = false;
      isPainting = false;
      editCanvas.classList.remove('painting');
      setWorkingIndicator(false);
      updateStatusMode();
    }

    editCanvas.addEventListener('mouseup', stopPainting);
    editCanvas.addEventListener('mouseleave', stopPainting);
    window.addEventListener('mouseup', stopPainting);

    // -------------------------------------------------------------------------
    // Download
    // -------------------------------------------------------------------------
    downloadPngBtn.addEventListener('click', () => {
      if (!hasImage) return;
      // ensure current canvas is basis
      const link = document.createElement('a');
      link.download = 'bgone-output.png';
      link.href = editCanvas.toDataURL('image/png');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // -------------------------------------------------------------------------
    // Init
    // -------------------------------------------------------------------------
    applyTheme();
    applyLanguage();
    resetApp();
  </script>
</body>
</html>
